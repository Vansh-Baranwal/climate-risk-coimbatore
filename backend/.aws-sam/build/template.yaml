AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Climate Risk Intelligence System for Coimbatore Backend services for
  disaster amplification visualization.

  '
Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    Environment:
      Variables:
        OPENWEATHER_API_KEY:
          Ref: OpenWeatherApiKey
Parameters:
  OpenWeatherApiKey:
    Type: String
    Description: API Key for OpenWeather (store in Parameter Store in prod, .env in
      dev)
    NoEcho: true
Resources:
  ClimateRiskApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: dev
      Cors:
        AllowMethods: '''*'''
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
  WeatherIngestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: WeatherIngestFunction
      Handler: lambdas/weather/ingest.handler
      Events:
        GetWeather:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /weather
            Method: get
    Metadata:
      SamResourceId: WeatherIngestFunction
  ZoneProviderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ZoneProviderFunction
      Handler: lambdas/zones/provider.handler
      Events:
        GetZones:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /zones
            Method: get
    Metadata:
      SamResourceId: ZoneProviderFunction
  FireRiskEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FireRiskEngineFunction
      Handler: lambdas/fire/engine.handler
      Events:
        CalculateFireRisk:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /risk/fire
            Method: post
    Metadata:
      SamResourceId: FireRiskEngineFunction
  DiseaseRiskEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DiseaseRiskEngineFunction
      Handler: lambdas/disease/engine.handler
      Events:
        CalculateDiseaseRisk:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /risk/disease
            Method: post
    Metadata:
      SamResourceId: DiseaseRiskEngineFunction
  DelayedRiskEvaluatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DelayedRiskEvaluatorFunction
      Handler: lambdas/delayed/evaluator.handler
      Events:
        EvaluateDelayed:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /risk/delayed/evaluate
            Method: post
    Metadata:
      SamResourceId: DelayedRiskEvaluatorFunction
  DelayedRiskSchedulerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DelayedRiskSchedulerFunction
      Handler: lambdas/delayed/scheduler.handler
      Events:
        ScheduleDelayed:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /risk/delayed/schedule
            Method: post
    Metadata:
      SamResourceId: DelayedRiskSchedulerFunction
  DelayedRiskExecutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DelayedRiskExecutorFunction
      Handler: lambdas/delayed/executor.handler
      Events:
        ExecuteDelayed:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /risk/delayed/execute
            Method: post
    Metadata:
      SamResourceId: DelayedRiskExecutorFunction
  InterventionSimulationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: InterventionSimulationFunction
      Handler: lambdas/simulation/intervention.handler
      Events:
        SimulateIntervention:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /simulation
            Method: post
    Metadata:
      SamResourceId: InterventionSimulationFunction
  AuthLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AuthLoginFunction
      Handler: lambdas/auth/login.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTable
      Environment:
        Variables:
          USERS_TABLE:
            Ref: UsersTable
      Events:
        Login:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /auth/login
            Method: post
    Metadata:
      SamResourceId: AuthLoginFunction
  AlertBroadcastFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AlertBroadcastFunction
      Handler: lambdas/alerts/broadcast.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AlertsTable
      Environment:
        Variables:
          ALERTS_TABLE:
            Ref: AlertsTable
      Events:
        GetAlerts:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /alerts
            Method: get
        PostAlert:
          Type: Api
          Properties:
            RestApiId:
              Ref: ClimateRiskApi
            Path: /alerts
            Method: post
    Metadata:
      SamResourceId: AlertBroadcastFunction
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ClimateRiskUsers
      AttributeDefinitions:
      - AttributeName: username
        AttributeType: S
      KeySchema:
      - AttributeName: username
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
  AlertsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ClimateRiskAlerts
      AttributeDefinitions:
      - AttributeName: id
        AttributeType: S
      - AttributeName: timestamp
        AttributeType: S
      KeySchema:
      - AttributeName: id
        KeyType: HASH
      - AttributeName: timestamp
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
Outputs:
  ApiURL:
    Description: API Gateway endpoint URL for Dev stage
    Value:
      Fn::Sub: https://${ClimateRiskApi}.execute-api.${AWS::Region}.amazonaws.com/dev/
