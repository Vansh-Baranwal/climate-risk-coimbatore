AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Climate Risk Intelligence System for Coimbatore
  Backend services for disaster amplification visualization.

Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    Environment:
      Variables:
        OPENWEATHER_API_KEY: !Ref OpenWeatherApiKey

Parameters:
  OpenWeatherApiKey:
    Type: String
    Description: API Key for OpenWeather (store in Parameter Store in prod, .env in dev)
    NoEcho: true

Resources:
  # --- API Gateway ---
  ClimateRiskApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: dev
      Cors:
        AllowMethods: "'*'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"

  # --- Lambdas ---
  # NOTE: CodeUri is set to '.' (backend root) so Lambdas can require shared code from ../../services/

  # 1. Weather Ingest
  WeatherIngestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/weather/ingest.handler
      Events:
        GetWeather:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /weather
            Method: get

  # 2. Zone Provider
  ZoneProviderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/zones/provider.handler
      Events:
        GetZones:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /zones
            Method: get

  # 3. Fire Risk Engine
  FireRiskEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/fire/engine.handler
      Events:
        CalculateFireRisk:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /risk/fire
            Method: post

  # 4. Disease Risk Engine
  DiseaseRiskEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/disease/engine.handler
      Events:
        CalculateDiseaseRisk:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /risk/disease
            Method: post

  # 5, 6, 7. Delayed Risk Group
  DelayedRiskEvaluatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/delayed/evaluator.handler
      Events:
        EvaluateDelayed:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /risk/delayed/evaluate
            Method: post

  DelayedRiskSchedulerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/delayed/scheduler.handler
      Events:
        ScheduleDelayed:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /risk/delayed/schedule
            Method: post

  DelayedRiskExecutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/delayed/executor.handler
      Events:
        ExecuteDelayed:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /risk/delayed/execute
            Method: post

  # 8. Intervention Simulation
  InterventionSimulationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/simulation/intervention.handler
      Events:
        SimulateIntervention:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /simulation
            Method: post

  # --- Phase 2: Auth & Database ---
  
  # 9. Auth Login
  AuthLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/auth/login.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
      Events:
        Login:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /auth/login
            Method: post

  # 9b. Auth Signup
  AuthSignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/auth/signup.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - Statement:
            - Effect: Allow
              Action:
                - sns:Subscribe
                - sns:Publish
              Resource: !Ref ClimateRiskAlertsTopic
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
          SNS_TOPIC_ARN: !Ref ClimateRiskAlertsTopic
      Events:
        Signup:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /auth/signup
            Method: post

  # 10. Alert Broadcast
  AlertBroadcastFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      Handler: lambdas/alerts/broadcast.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AlertsTable
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref ClimateRiskAlertsTopic
      Environment:
        Variables:
          ALERTS_TABLE: !Ref AlertsTable
          SNS_TOPIC_ARN: !Ref ClimateRiskAlertsTopic
      Events:
        GetAlerts:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /alerts
            Method: get
        PostAlert:
          Type: Api
          Properties:
            RestApiId: !Ref ClimateRiskApi
            Path: /alerts
            Method: post

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ClimateRiskUsers
      AttributeDefinitions:
        - AttributeName: username
          AttributeType: S
      KeySchema:
        - AttributeName: username
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  # --- SNS Topic ---
  ClimateRiskAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: ClimateRiskAlerts

  # --- Frontend Hosting (S3 + CloudFront) ---

  AlertsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ClimateRiskAlerts
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  # --- Frontend Hosting (S3 + CloudFront) ---
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "climate-risk-coimbatore-frontend-${AWS::AccountId}"
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: "*"
            Action: "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${FrontendBucket}/*"

  FrontendDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: S3Origin
            DomainName: !Select [2, !Split ["/", !GetAtt FrontendBucket.WebsiteURL]]
            CustomOriginConfig:
              OriginProtocolPolicy: http-only
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html

Outputs:
  ApiURL:
    Description: "API Gateway endpoint URL for Dev stage"
    Value: !Sub "https://${ClimateRiskApi}.execute-api.${AWS::Region}.amazonaws.com/dev/"
  
  FrontendURL:
    Description: "CloudFront Distribution URL"
    Value: !GetAtt FrontendDistribution.DomainName
  
  S3BucketName:
    Description: "S3 Bucket for Frontend"
    Value: !Ref FrontendBucket
